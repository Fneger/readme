# 扇区修复

## 惩罚项目

惩罚项目主要在：
1.gas费设置不合理（GasLimit和GasUsage之间的差异较大时，燃烧的额外gas量会增加,当GasLimit大于Gas实际消耗1.1倍即为不合理，多余部分按over/gasUsed惩罚）
2.扇区故障或扇区提前终止

## 扇区故障惩罚费用说明

对于存储提供商来说，有很大的动力去向链上报告故障并尝试从故障中恢复，以维护网络客户的存储保证是非常重要的。没有这种动机，就不可能将诚实的矿工的硬件故障与恶意行为区分开，这对于公平地对待矿工是必不可少的。故障费用的大小取决于故障的严重程度以及矿工期望从该部门获得的报酬，以确保激励措施一致。扇区存储故障费用的三种类型为：
扇区故障费：在扇区处于故障状态时，每天为每个扇区支付此费用。费用的大小略大于该行业每天期望获得的大块奖励的金额。如果某个扇区连续两个星期以上仍存在故障，则该扇区将支付终止费并从连锁状态中删除。当存储矿工的可靠性提高到合理阈值以上时，这些费用带来的风险将迅速降低。
部门故障检测费：如果矿工未如实报告事故，而是链上发现了未报告的故障，这是发生故障时支付的一次性费用。考虑到PoSt支票的概率性质，这将设置为几天有望由特定部门获得的块奖励。
部门终止费：通过自动故障或矿工决策，可以在扇区到期之前终止该扇区。收取终止费，原则上是等于一个部门迄今已赚取的收入，但要达到一定的上限，以免影响较长的使用寿命。在主动终止合同时，矿工决定停止采矿，并支付离开的费用。在故障终止中，一个扇区处于故障状态的时间过长，并且链终止了交易，将未付的交易费用退还给客户，并对矿工进行了处罚。目前，终止费的上限是一个行业将获得的90天区块奖励。矿工有责任决定遵守当地法规，有时可能需要接受终止费才能遵守内容法。上面的许多概念和参数都利用“一个行业一天能赚多少钱”的概念来理解和调整对参与者的激励措施。该概念在链上得到了可靠的跟踪和推断。

---------------------------------------------------------------------------------------------------------------

## 错误、罚款和费用债务

部门的PoSt必须及时提交，或者该部门标记为“有问题的”。故障分为三种：

宣告故障：当矿工在截止日期的FaultCutoff之前明确宣布某个部门“有故障”时。回想一下，WindowPoSt针对特定分区的每个分区都提交了证明ChallengeWindow。矿工必须ChallengeWindow在特定分区打开之前将扇区声明为有缺陷的。在恢复扇区之前，它们将在随后的验证期间被屏蔽。
检测到的故障：没有经过PoSt验证记录的扇区的分区，FaultCutoff被标记为检测到的故障，这些分区在纪元的期限之前没有被宣布为故障。
跳过故障：如果某个扇区当前处于活动或恢复状态，并且之前没有被声明为故障，但是矿工的PoSt提交中未包含该扇区的证明，则该扇区为“跳过故障”扇区（也称为“跳过未声明的错误”）。换句话说，当矿工提交分区的PoSt证明但不包括分区中某些扇区的证明时，则这些扇区处于“跳过故障”状态。这与“检测到的故障”状态相反，在该状态下，矿工根本不提交分区中任何部分的PoSt证明。如果在该FaultCutoff时期之后扇区出现故障，则跳过的故障很有用。
请注意，与“检测到的故障”的情况相比，与分区范围的故障和惩罚相比，“跳过的故障”允许按扇区划分的错误惩罚。

截止期限

甲期限是一段WPoStChallengeWindow时期划分一个验证期。部门被指定为截止日期，miner.ProveCommitSector并将在整个生命周期中一直分配给它。回想一下，扇区也被分配给一个分区。

矿工必须miner.SubmitWindowedPoSt在每个截止日期之前提交。

截止日期有四个相关的时期：

名称	距 Open	描述
Open	0	可以提交此截止日期的PoSt证明的纪元。
Close	WPoStChallengeWindow	在此期限之后的PoSt证明将被拒绝。
FaultCutoff	-FaultDeclarationCutoff	在即将到来的截止日期之后拒绝aminer.DeclareFault和miner.DeclareFaultRecoveredfor部门的时期。
Challenge	-WPoStChallengeLookback	挑战随机性可用的纪元。

故障恢复

不管首先如何得知（声明，跳过，检测到）故障，该扇区都将保持故障状态，并将其排除在以后的证明之外，直到矿工明确声明已恢复。恢复声明将使该扇区恢复到下一个证明期开始时的证明集。收到刚刚恢复的扇区的PoSt时，将恢复该扇区的算力。

罚则

矿工可能会因许多原因而受到罚款：

预交付期满罚金：如果扇区未能及时ProveCommit进入预交付区，则发生此事件。这是矿工第一次宣布自己证明自己是一个扇区并符合PoRep共识时发生的情况。
未申报的过错处罚：如果矿工未能按时为某个扇区提交PoSt，则会发生。根据是否实施了“跳过故障”选项，此惩罚适用于扇区或整个分区。
宣布的故障处罚：如果矿工未能按时提交针对某个扇区的PoSt，但是在系统发现之前，他们宣布该部门有故障（在这种情况下，故障属于上述“未宣布的故障处罚”）。该罚款应低于未申报的过失罚款，以激励矿工及早申报过失。
持续的错误处罚：矿工在每个验证周期内均未提交针对某个扇区的PoSt。
终止罚款：如果某个扇区在其到期之前终止，则发生。
共识错误惩罚：如果矿工犯了共识错误并被报告，则发生。
当矿工产生罚金时，罚金被追踪为“费用债务”。如果矿工有费用债务，则他们只能采取某些行动，直到还清欠款为止。
有费用债务的矿工不得：

预先提交新部门
宣布“恢复”故障部门
取款余额

错误被暗示为“暂时的”-也就是说，暂时失去互联网连接的矿工可能会选择将某些扇区声明为即将到来的证明阶段是错误的，因为该矿工知道他们最终将重新获得为这些部门提交证据的能力。该声明使矿工仍可以提交有效的截止日期证明（减去有缺陷的部门）。这对矿工来说非常重要，因为错过截止日期的PoSt完全会导致高额罚款。

## 扇区错误恢复

为了避免支付罚款，矿工应设法追回有缺陷的部门，这大约等于矿工将从该部门获得的整体奖励。解决技术问题后，矿工应致电RecoveryDeclaration并提出WindowPoSt挑战，以重新获得该部门的力量。

请注意，如果一个扇区连续14天处于故障状态，它将被终止，矿工将受到罚款。如果矿工TerminationDeclaration知道自己无法收回该部门，则可以通过致电自己来终止该部门，在这种情况下，他们将受到较小的罚款。

PreCommitFailed: lotus-miner sectors remove --really-do-it <sectorId>
SealPreCommit1Failed: lotus-miner sectors remove --really-do-it <sectorId>
CommitFailed: lotus-miner sectors update-state --really-do-it <sectorId> Committing





